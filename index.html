<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Ledger</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 3em 1em 3em 1em;
            height: 100vh;
        }
        .zoom-controls {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
            margin: 1em;
        }
        .filled {
            background-color: lightgreen;
        }
        .no input[type="number"] {
            text-align: center;
        }
        input[type='number']::-webkit-inner-spin-button, 
        input[type='number']::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        .grid-container {
            display: grid;
            gap: 1rem;
            margin: 1em 0;
        }
        .grid-container.visitor-counts {
            grid-template-columns: repeat(auto-fit, minmax(133px, 150px));
            grid-auto-rows: minmax(70px, auto);
            justify-content: space-evenly;
        }
        .grid-container.other {
            grid-template-columns: repeat(auto-fit, minmax(133px, 1fr));
            grid-auto-rows: minmax(70px, auto);
        }
        .no {
            text-align: center;
        }
        label:has(~ select[disabled]) {
            color: lightgray;
        }
        .form-footer {
            text-align: center;
            padding-bottom: 6em;
        }
        .with-gift-aid .btn-outline-secondary {
            background-color: #e1bee7;
            color: #212529;
        }
        .with-gift-aid .btn-outline-secondary:hover {
            background-color: #ce93d8;
            color: #212529;
        }
        .with-gift-aid label:after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: text-bottom;
            background: url('images/gift-icon.svg') no-repeat center;
            background-size: contain;
            margin-left: 4px;
        }
        .alert-float {
            position: fixed;
            top: 1em;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
            display: none;
            padding: 1em 2em;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="alertMessage" class="alert-float alert alert-success"></div>
    <!-- Template for visitor count inputs -->
    <template id="visitor-count-template">
        <div class="no">
            <label for="" class="form-label"></label>
            <div class="input-group input-group-lg">
                <input type="number" readonly id="" name="" min="0" value="0" step="1" class="form-control visitor-count">
            </div>
        </div>
    </template>

    <form action="/submit" method="post" autocomplete="off">
        <div id="defaultVisitorCounts" class="grid-container visitor-counts">
        </div>
        <div class="accordion" id="otherVisitorOptionsAccordian">
            <div class="accordion-item">
                <h2 class="accordion-header" id="otherOptionsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#otherOptions" aria-expanded="false" aria-controls="otherOptions" style="background-color: #EEEEEE; border: 1px solid #6c757d; color: #6c757d;">
                        Other Visitor Types & Gift Aid Options
                    </button>
                </h2>
                <div id="otherOptions" class="accordion-collapse collapse" aria-labelledby="otherOptionsHeading" data-bs-parent="#otherVisitorOptionsAccordian">
                    <div class="accordion-body">
                        <div id="otherVisitorCounts" class="grid-container visitor-counts">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid-container other">
            <div style="grid-column: 1;">
                <label for="postcode" class="form-label">Postcode/Country</label>
                <input type="text" id="postcode" name="postcode" required style="text-transform: uppercase;" class="form-control form-control-lg">
            </div>
            <div>
                <label for="reason-for-visit" class="form-label">Reason for Visit</label>
                <select id="reason-for-visit" name="reason-for-visit" class="form-control form-control-lg">
                    <option value="temporary-exhibition">Temporary Exhibition</option>
                    <option value="craft-activities">Craft Activities</option>
                    <option value="special-event-exhibition">Special Event/Exhibition</option>
                    <option value="tivvy-bumper-rail-enthusiast">Tivvy Bumper/Rail Enthusiast</option>
                    <option value="using-tourist-information-service">Using Tourist Information Service</option>
                    <option value="just-visiting" selected>Just visiting</option>
                    <option value="research-visit">Research Visit</option>
                    <option value="tivvy-bumper-trail">Tivvy Bumper Trail</option>
                </select>
            </div>
            <div>
                <label for="visit-type" class="form-label">Pre-Booked</label>
                <select id="visit-type" name="visit-type" class="form-control form-control-lg">
                    <option value="walk-in" selected>No</option>
                    <option value="pre-booked">Yes</option>
                </select>
            </div>

            <div style="grid-column: 1;">
                <label for="first-visit" class="form-label">First Visit?</label>
                <select id="first-visit" name="first-visit" class="form-control form-control-lg" required>
                    <option value="" disabled selected>&nbsp;</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div style="grid-column: span 2;">
                <label for="hear-about-us" class="form-label">How did you hear about us?</label>
                <select id="hear-about-us" name="hear-about-us" class="form-control form-control-lg" disabled required>
                    <option value="" disabled selected></option>
                    <option value="previous-knowledge">Previous Knowledge</option>
                    <option value="newspaper-magazine">Newspaper/Magazine</option>
                    <option value="event-exhibit-poster">Event/Exhibit poster</option>
                    <option value="advertising-display">Advertising Display - Leisure Centre/St. Peter's Church</option>
                    <option value="leaflet">Leaflet</option>
                    <option value="signs-in-town">Signs in the town</option>
                    <option value="word-of-mouth">Word of mouth</option>
                    <option value="website">Website</option>
                    <option value="social-media">Social Media</option>
                    <option value="other">Other - please specify</option>
                </select>
                <input type="text" id="other-hear-about-us" name="other-hear-about-us" class="form-control form-control-lg" style="display: none;" placeholder="Please specify" disabled required>
            </div>
            <div style="grid-column: 1;">
                <label for="price" class="form-label">Price (Â£)</label>
                <input type="number" id="price" name="price" min="0" step="0.01" value="0.00" readonly class="form-control-plaintext form-control-lg">
            </div>
        </div>
        <div class="form-footer">
            <p id="members-only-message" style="display: none;">(No other fields required as only members visiting)</p>
            <button type="submit" class="btn btn-lg btn-primary">Submit</button>
            <button type="reset" class="btn btn-lg btn-secondary">Reset</button>
        </div>
    </form>
</body>
</html>
<script>
    const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbzKUXx40l1FKaE5oiv2bQTCEK3Km-93zEd3pfYv9mYcIaT7Th1jOiRiZeEIfZ7oigxIfw/exec';

    // Prompt for token
    function promptForToken(clearExisting = false) {
        if (clearExisting) {
            localStorage.removeItem('authToken');
        }
        async function validateToken() {
            while (!localStorage.getItem('authToken')) {
                const token = prompt('Please enter the secret token:');
                if (token) {
                    try {
                        const response = await fetch(`${appsScriptUrl}?authToken=${token}`, {
                            method: 'GET',
                            headers: {
                                "Content-Type": "text/plain;charset=utf-8"
                            }
                        });
                        const result = await response.text();
                        if (result === 'Unauthorized') {
                            alert('The token is incorrect. Please try again.');
                        } else {
                            localStorage.setItem('authToken', token);
                            alert('Token is correct.');
                        }
                    } catch {
                        alert('An error occurred while checking the token. Please try again.');
                    }
                }
            }
        }

        validateToken();
    }

    // check token on page load
    $(document).ready(function() {
        promptForToken();
    });

    // add zoom buttons to the page
    $(document).ready(function() {
        const zoomButtons = $('<div class="btn-group zoom-controls" role="group" aria-label="Zoom buttons"></div>');
        const zoomLevels = [1, 1.25, 1.5, 1.75];

        zoomLevels.forEach(level => {
            const zoomButton = $(`<button type="button" class="btn btn-secondary ${level === 1 ? 'active' : ''}">${level}x</button>`);
            zoomButton.click(function() {
                $('form').css('zoom', level);
                zoomButtons.find('button').removeClass('active');
                $(this).addClass('active');
            });
            zoomButtons.append(zoomButton);
        });

        $('body').prepend(zoomButtons);
    });

    // visitor number inputs
    $(document).ready(function() {
        // Visitor types
        const visitorTypes = [
            { id: 'adults', price: 8.50, isAdult: true, label: 'Adults', shortLabel: 'Adults', visibleByDefault: true, donation: 0 },
            { id: 'adults-gift-aid', price: 9.35, isAdult: true, label: 'Gift Aid Adults', shortLabel: 'Gift Aid Adults', visibleByDefault: true, donation: 0.85 },
            { id: 'children', price: 0, isAdult: false, label: 'Children', shortLabel: 'Children', visibleByDefault: true, donation: 0 },
            { id: 'members', price: 0, isAdult: true, label: 'Members', shortLabel: 'Members', visibleByDefault: true, donation: 0 },
            { id: 'carers', price: 0, isAdult: true, label: 'Carers', shortLabel: 'Carers', visibleByDefault: false, donation: 0 },
            { id: 'blue-light', price: 7.22, isAdult: true, label: 'Blue Light', shortLabel: 'Blue Light', visibleByDefault: false, donation: 0 },
            { id: 'blue-light-gift-aid', price: 7.94, isAdult: true, label: 'Gift Aid Blue Light', shortLabel: 'Gift Aid BL', visibleByDefault: false, donation: 0.72 },
            { id: 'dogs', price: 0, isAdult: false, label: 'Dogs', shortLabel: 'Dogs', visibleByDefault: true, donation: 0 },
            { id: 'half-price-voucher', price: 4.25, isAdult: true, label: 'Half Price Voucher', shortLabel: '1/2 Price Voucher', visibleByDefault: false, donation: 0 },
            { id: 'half-price-voucher-gift-aid', price: 4.68, isAdult: true, label: 'Gift Aid Half Price Voucher', shortLabel: 'Gift Aid 1/2 Price', visibleByDefault: false, donation: 0.43 },
            { id: 'full-price-voucher', price: 8.50, isAdult: true, label: 'Full Price Voucher', shortLabel: 'Full Price Voucher', visibleByDefault: false, donation: 0 }
        ];

        // Build visitor count inputs dynamically
        visitorTypes.forEach(type => {
            const template = $('#visitor-count-template').html();
            const newElement = $(template).clone();

            newElement.find('label')
                .attr('for', type.id)
                .text(type.shortLabel)
                .attr('title', type.label)
                .attr('data-bs-toggle', 'tooltip')
                .attr('data-bs-placement', 'top');
            
            const input = newElement.find('input')
                .attr('id', type.id)
                .attr('name', type.id);

            if (type.donation > 0) {
                newElement.addClass('with-gift-aid');
            }

            if (type.visibleByDefault) {
                $('#defaultVisitorCounts').append(newElement);
            } else {
                $('#otherVisitorCounts').append(newElement);
            }
        });

        // Initialize tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Update price and visibility logic
        function updatePriceAndVisibility() {
            let totalPrice = 0;
            let totalAdults = 0;
            let totalChildren = 0;
            const totalMembers = parseInt($('#members').val()) || 0;

            visitorTypes.forEach(type => {
                const count = parseInt($(`#${type.id}`).val()) || 0;
                totalPrice += count * type.price;

                if (type.isAdult) {
                    totalAdults += count;
                } else if (type.id === 'children') {
                    totalChildren += count;
                }
            });

            // Apply special pricing for children-only visits
            if (totalChildren > 0 && totalAdults === 0) {
                totalPrice += totalChildren * 1;
            }

            $('#price').val(totalPrice.toFixed(2));

            // Toggle visibility of additional fields
            if (totalAdults > 0 && totalMembers === totalAdults) {
                $('.grid-container.other').hide();
                $('#members-only-message').show();
            } else {
                $('.grid-container.other').show();
                $('#members-only-message').hide();
            }
        }

        // Attach event listeners
        $('.visitor-count').on('input change', updatePriceAndVisibility);
    });

    // add plus and minus buttons to number inputs
    $(document).ready(function() {
        const numberInputs = $('.no input[type="number"]');

        numberInputs.each(function() {
            const numberInput = $(this);
            const minusButton = $('<button type="button" class="btn btn-outline-secondary">-</button>');
            const plusButton = $('<button type="button" class="btn btn-outline-secondary">+</button>');

            numberInput.before(minusButton);
            numberInput.after(plusButton);

            minusButton.click(function() {
                numberInput[0].stepDown();
                numberInput.trigger('input');
            });

            plusButton.click(function() {
                numberInput[0].stepUp();
                numberInput.trigger('input');
            });
        });
    });

    // form state management
    $(document).ready(function() {
        function updateFieldFilledState() {
            if ($(this).is('input[type="number"]') && $(this).val() > 0 || !$(this).is('input[type="number"]') && $(this).val()) {
                $(this).addClass('filled');
            } else {
                $(this).removeClass('filled');
            }
        }

        function updateFormDependencies() {
            const firstVisit = $('#first-visit').val();
            const hearAboutUs = $('#hear-about-us');
            const otherHearAboutUs = $('#other-hear-about-us');

            // First Visit -> How did you hear about us
            hearAboutUs.prop('disabled', firstVisit !== 'yes');
            
            // How did you hear about us -> Other specification
            if (hearAboutUs.val() === 'other') {
                otherHearAboutUs.show().prop('disabled', false);
            } else {
                otherHearAboutUs.hide().prop('disabled', true);
            }
        }

        // Attach event listeners
        $('input, textarea, select').on('input change', updateFieldFilledState);
        $('#first-visit, #hear-about-us').on('change', updateFormDependencies);
        
        // Handle form reset
        $('form').on('reset', function() {
            setTimeout(function() {
                $('input, textarea, select').each(updateFieldFilledState);
                updateFormDependencies();
            }, 0);
        });

        // Initialize on page load
        $('input, textarea, select').each(updateFieldFilledState);
        updateFormDependencies();
    });

    // don't submit the form if all number inputs are 0
    $(document).ready(function() {
        $('form').submit(function(event) {
            let sum = 0;
            $('.visitor-count').each(function() {
                sum += parseInt($(this).val());
            });

            if (sum === 0) {
                alert('Please enter at least one visitor');
                event.preventDefault(); // Prevent form submission
                event.stopImmediatePropagation(); // Stop other submit listeners
            }
        });
    });

    // ask for confirmation before resetting the form
    $(document).ready(function() {
        $('button[type="reset"]').click(function(event) {
            if (!confirm('Are you sure you want to reset the form?')) {
                event.preventDefault();
            }
        });
    });

    function showAlert(message, duration = 3000) {
        const alert = $('#alertMessage');
        alert.text(message).fadeIn();
        setTimeout(() => alert.fadeOut(), duration);
    }

    // post form data to the Spreadsheet's Apps Script
    $(document).ready(function() {
        $('form').submit(function(event) {
            event.preventDefault();

            const submitButton = $(this).find('button[type="submit"]');
            submitButton.prop('disabled', true).text('Processing...');

            const formData = new FormData(this);
            formData.append('price', $('#price').val());
            formData.append('timestamp', new Date().toISOString());

            const body = { 
                record: Object.fromEntries(formData.entries()), 
                authToken: localStorage.getItem('authToken')
            };

            fetch(appsScriptUrl, {
                method: 'POST',
                headers: {
                    "Content-Type": "text/plain;charset=utf-8",
                },
                body: JSON.stringify(body)
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error('An error occurred while submitting the form');
                }

                const res = await response.text();
                switch (res) {
                    case 'Success':
                        showAlert('Saved successfully');
                        $('form').trigger('reset');
                        break;
                    case 'Unauthorized':
                        alert('Unauthorized access. The secret token is incorrect. Please enter correct token and then try again.');
                        promptForToken(true);
                        break;
                    default:
                        throw new Error('An error occurred while submitting the form');
                }
            })
            .catch(error => {
                alert(error);
            })
            .finally(() => {
                submitButton.prop('disabled', false).text('Submit');
            });
        });
    });
</script>