<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Ledger</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 3em 1em 3em 1em;
            height: 100vh;
        }
        .zoom-controls {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
            margin: 1em;
        }
        .filled {
            background-color: lightgreen;
        }
        .no input[type="number"] {
            text-align: center;
        }
        input[type='number']::-webkit-inner-spin-button, 
        input[type='number']::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        .grid-container {
            display: grid;
            gap: 1rem;
            margin: 1em 0;
        }
        .grid-container.visitor-counts {
            grid-template-columns: repeat(auto-fit, minmax(133px, 150px));
            grid-auto-rows: minmax(70px, auto);
            justify-content: space-evenly;
        }
        .grid-container.other {
            grid-template-columns: repeat(auto-fit, minmax(133px, 1fr));
            grid-auto-rows: minmax(70px, auto);
        }
        .no {
            text-align: center;
        }
        label:has(~ select[disabled]) {
            color: lightgray;
        }
        .form-footer {
            text-align: center;
            padding-bottom: 6em;
        }
        .with-gift-aid label:after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: text-bottom;
            background: url('images/gift-icon.svg') no-repeat center;
            background-size: contain;
            margin-left: 4px;
        }
        .alert-float {
            position: fixed;
            top: 1em;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
            display: none;
            padding: 1em 2em;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .accordion-button::after {
            margin-left: 0;
            margin-right: 0.5em;
            order: -1;
        }
        .accordion-button {
            display: flex;
            justify-content: flex-start;
        }
        .no .btn {
            font-family: monospace;
        }
        .postcode-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1050;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            will-change: transform;
        }
        .postcode-modal.show {
            transform: translateY(0);
        }
        .postcode-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }
    </style>
</head>
<body>
    <div id="alertMessage" class="alert-float alert alert-success"></div>
    <!-- Template for visitor count inputs -->
    <template id="visitor-count-template">
        <div class="no">
            <label for="" class="form-label"></label>
            <div class="input-group input-group-lg">
                <input type="number" readonly id="" name="" min="0" value="0" step="1" class="form-control visitor-count">
            </div>
        </div>
    </template>

    <form action="/submit" method="post" autocomplete="off">
        <div id="defaultVisitorCounts" class="grid-container visitor-counts">
        </div>
        <div class="accordion" id="otherVisitorOptionsAccordian">
            <div class="accordion-item">
                <h2 class="accordion-header" id="otherOptionsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#otherOptions" aria-expanded="false" aria-controls="otherOptions" style="background-color: #EEEEEE; border: 1px solid #7b7b7b; color: #282828;">
                        Other Visitor Types & Gift Aid Options
                    </button>
                </h2>
                <div id="otherOptions" class="accordion-collapse collapse" aria-labelledby="otherOptionsHeading" data-bs-parent="#otherVisitorOptionsAccordian">
                    <div class="accordion-body">
                        <div id="otherVisitorCounts" class="grid-container visitor-counts">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid-container other">
            <div style="grid-column: 1;">
                <label for="postcode" class="form-label">Postcode/Country</label>
                <input type="text" id="postcode" name="postcode" required style="text-transform: uppercase;" class="form-control form-control-lg">
            </div>
            <div>
                <label for="reason-for-visit" class="form-label">Reason for Visit</label>
                <select id="reason-for-visit" name="reason-for-visit" class="form-control form-control-lg">
                    <option value="visitor-to-town">1. Visitor to the Town</option>
                    <option value="craft-activities">2. Craft Activities</option>
                    <option value="special-event-exhibition">3. Special Event / Exhibition</option>
                    <option value="tivvy-bumper-rail-enthusiast">4. Tivvy Bumper/Rail Enthusiast</option>
                    <option value="using-tourist-information-service">5. Using TIC</option>
                    <option value="just-visiting" selected>6. Just Visiting</option>
                    <option value="research-visit">7. Research Visit</option>
                    <option value="other">8. Other</option>
                </select>
            </div>
            <div>
                <label for="visit-type" class="form-label">Pre-Booked</label>
                <select id="visit-type" name="visit-type" class="form-control form-control-lg">
                    <option value="walk-in" selected>No</option>
                    <option value="pre-booked">Yes</option>
                </select>
            </div>

            <div style="grid-column: 1;">
                <label for="first-visit" class="form-label">First Visit?</label>
                <select id="first-visit" name="first-visit" class="form-control form-control-lg" required>
                    <option value="" disabled selected>&nbsp;</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div style="grid-column: span 2;">
                <label for="hear-about-us" class="form-label">How did you hear about us?</label>
                <select id="hear-about-us" name="hear-about-us" class="form-control form-control-lg" disabled required>
                    <option value="" disabled selected></option>
                    <option value="newspaper-magazine">A. Newspaper / Magazine</option>
                    <option value="poster">B. Poster</option>
                    <option value="advertising-display">C. Advertising Display - Leisure Centre/Market</option>
                    <option value="leaflet">D. Leaflet</option>
                    <option value="signs-in-town">E. Signs in the town</option>
                    <option value="word-of-mouth">F. Word of mouth</option>
                    <option value="website">G. Website</option>
                    <option value="previous-visit">H. Previous Visit</option>
                    <option value="social-media">I. Social Media</option>
                    <option value="local-resident">J. Local Resident</option>
                    <option value="other">K. Other - please specify</option>
                </select>
                <input type="text" id="other-hear-about-us" name="other-hear-about-us" class="form-control form-control-lg" style="display: none;" placeholder="Please specify" disabled required>
            </div>
        </div>
        <div class="form-footer">
            <p id="members-only-message" style="display: none;">(No other fields required as only members visiting)</p>
            <p id="summary-message" class="text-muted mb-3"></p>
            <button type="submit" class="btn btn-lg btn-primary">Submit</button>
            <button type="reset" class="btn btn-lg btn-secondary">Reset</button>
        </div>
    </form>
    <div class="postcode-modal-backdrop"></div>
    <div class="postcode-modal">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Enter Postcode/Country</h5>
        </div>
        <input type="text" id="postcodeInput" class="form-control form-control-lg mb-3" style="text-transform: uppercase;">
        <div class="d-grid">
            <button type="button" class="btn btn-primary btn-lg" id="donePostcode">Save</button>
        </div>
    </div>
</body>
</html>
<script>
(() => {
    const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbyxHZBcYsJ-AF9Xf2VyFBbYP7QhSJGoaBevq8I_RXnXe6_lYYy0ntYpgs-9z8DNwRLM4w/exec';

    const visitorTypes = [
        { id: 'adults', price: 8.50, isAdult: true, label: 'Adults', shortLabel: 'Adults', visibleByDefault: true, donation: 0 },
        { id: 'adults-gift-aid', price: 9.35, isAdult: true, label: 'Gift Aid Adults', shortLabel: 'Gift Aid Adults', visibleByDefault: true, donation: 0.85 },
        { id: 'members', price: 0, isAdult: true, label: 'Members', shortLabel: 'Members', visibleByDefault: true, donation: 0 },
        { id: 'children', price: 0, isAdult: false, label: 'Children', shortLabel: 'Children', visibleByDefault: true, donation: 0 },
        { id: 'carers', price: 0, isAdult: true, label: 'Carers', shortLabel: 'Carers', visibleByDefault: false, donation: 0 },
        { id: 'blue-light', price: 7.22, isAdult: true, label: 'Blue Light', shortLabel: 'Blue Light', visibleByDefault: false, donation: 0 },
        { id: 'blue-light-gift-aid', price: 7.94, isAdult: true, label: 'Gift Aid Blue Light', shortLabel: 'Gift Aid BL', visibleByDefault: false, donation: 0.72 },
        { id: 'dogs', price: 0, isAdult: false, label: 'Dogs', shortLabel: 'Dogs', visibleByDefault: true, donation: 0 },
        { id: 'half-price-voucher', price: 4.25, isAdult: true, label: 'Half Price Voucher', shortLabel: '1/2 Price Voucher', visibleByDefault: false, donation: 0 },
        { id: 'half-price-voucher-gift-aid', price: 4.67, isAdult: true, label: 'Gift Aid Half Price Voucher', shortLabel: 'Gift Aid 1/2 Price', visibleByDefault: false, donation: 0.42 },
        { id: 'free-entry-voucher', price: 0, isAdult: true, label: 'Free Entry Voucher', shortLabel: 'Free Entry Voucher', visibleByDefault: false, donation: 0 }
    ];

    function calculateTotalPrice() {
        let totalPrice = 0;
        let totalChildren = 0;
        let totalAdults = 0;

        visitorTypes.forEach(type => {
            const count = parseInt($(`#${type.id}`).val()) || 0;
            totalPrice += count * type.price;

            if (type.isAdult) {
                totalAdults += count;
            } else if (type.id === 'children') {
                totalChildren += count;
            }
        });

        // Apply special pricing for children-only visits
        if (totalChildren > 0 && totalAdults === 0) {
            totalPrice += totalChildren * 1;
        }

        return totalPrice;
    }

    function updateFormSummaryAndVisibility() {
        let totalAdults = 0;
        let totalChildren = 0;
        let totalDogs = parseInt($('#dogs').val()) || 0;
        let totalVisitors = 0;
        const totalMembers = parseInt($('#members').val()) || 0;

        visitorTypes.forEach(type => {
            const count = parseInt($(`#${type.id}`).val()) || 0;
            if (type.isAdult) {
                totalAdults += count;
            } else if (type.id === 'children') {
                totalChildren += count;
            }
            
            if (type.id !== 'dogs') {
                totalVisitors += count;
            }
        });

        // Update summary message
        let summaryParts = [];
        if (totalAdults > 0) {
            summaryParts.push(`${totalAdults} adult${totalAdults !== 1 ? 's' : ''}`);
        }
        if (totalChildren > 0) {
            summaryParts.push(`${totalChildren} ${totalChildren === 1 ? 'child' : 'children'}`);
        }
        if (totalDogs > 0) {
            summaryParts.push(`${totalDogs} dog${totalDogs !== 1 ? 's' : ''}`);
        }
        
        let summaryText = summaryParts.join(', ');
        if (summaryText) {
            summaryText += ` - £${calculateTotalPrice().toFixed(2)}`;
        }
        $('#summary-message').text(summaryText || 'No visitors selected');

        // Toggle visibility and required state of additional fields
        const isMembersOnly = totalAdults > 0 && totalMembers === totalAdults;
        $('.grid-container.other').toggle(!isMembersOnly);
        $('#members-only-message').toggle(isMembersOnly);
        
        // Update required attributes
        $('#postcode, #first-visit, #hear-about-us').prop('required', !isMembersOnly);
    }

    // Prompt for token
    function promptForToken(clearExisting = false) {
        if (clearExisting) {
            localStorage.removeItem('authToken');
        }
        async function validateToken() {
            while (!localStorage.getItem('authToken')) {
                const token = prompt('Please enter the secret token:');
                if (token) {
                    try {
                        const response = await fetch(`${appsScriptUrl}?authToken=${token}`, {
                            method: 'GET',
                            headers: {
                                "Content-Type": "text/plain;charset=utf-8"
                            }
                        });
                        const result = await response.text();
                        if (result === 'Unauthorized') {
                            alert('The token is incorrect. Please try again.');
                        } else {
                            localStorage.setItem('authToken', token);
                            alert('Token is correct.');
                        }
                    } catch {
                        alert('An error occurred while checking the token. Please try again.');
                    }
                }
            }
        }

        validateToken();
    }

    function showAlert(message, duration = 3000) {
        const alert = $('#alertMessage');
        alert.text(message).fadeIn();
        setTimeout(() => alert.fadeOut(), duration);
    }

    function initializeZoomControls() {
        const zoomButtons = $('<div class="btn-group zoom-controls" role="group" aria-label="Zoom buttons"></div>');
        const zoomLevels = [1, 1.25, 1.5, 1.75];

        zoomLevels.forEach(level => {
            const zoomButton = $(`<button type="button" class="btn btn-secondary ${level === 1 ? 'active' : ''}">${level}x</button>`);
            zoomButton.click(function() {
                $('form').css('zoom', level);
                zoomButtons.find('button').removeClass('active');
                $(this).addClass('active');
            });
            zoomButtons.append(zoomButton);
        });

        $('body').prepend(zoomButtons);
    }

    function initializeVisitorInputs() {
        visitorTypes.forEach(type => {
            const template = $('#visitor-count-template').html();
            const newElement = $(template).clone();

            newElement.find('label')
                .attr('for', type.id)
                .text(type.shortLabel)
                .attr('title', type.label)
                .attr('data-bs-toggle', 'tooltip')
                .attr('data-bs-placement', 'top');
            
            const input = newElement.find('input')
                .attr('id', type.id)
                .attr('name', type.id);

            if (type.donation > 0) {
                newElement.addClass('with-gift-aid');
            }

            if (type.visibleByDefault) {
                $('#defaultVisitorCounts').append(newElement);
            } else {
                $('#otherVisitorCounts').append(newElement);
            }
        });

        $('[data-bs-toggle="tooltip"]').tooltip();
        $('.visitor-count').on('input change', updateFormSummaryAndVisibility);
    }

    

    function initializeNumberControls() {
        const numberInputs = $('.no input[type="number"]');

        numberInputs.each(function() {
            const numberInput = $(this);
            const minusButton = $('<button type="button" class="btn btn-outline-secondary">-</button>');
            const plusButton = $('<button type="button" class="btn btn-outline-secondary">+</button>');

            numberInput.before(minusButton);
            numberInput.after(plusButton);

            minusButton.click(function() {
                numberInput[0].stepDown();
                numberInput.trigger('input');
            });

            plusButton.click(function() {
                numberInput[0].stepUp();
                numberInput.trigger('input');
            });
        });
    }
    
    function initializeAccordionBehavior() {
        const accordion = $('#otherOptions');
        const accordionButton = $('.accordion-button');

        // Prevent collapse if there are values
        $('#otherVisitorOptionsAccordian').on('hide.bs.collapse', function (e) {
            let hasValues = false;
            $('#otherVisitorCounts .visitor-count').each(function() {
                if (parseInt($(this).val()) > 0) {
                    hasValues = true;
                    return false; // break loop
                }
            });

            if (hasValues) {
                e.preventDefault();
                alert('Please set all "Other Visitor Types" values to 0 before closing this section');
            }
        });
    }

    function initializeFormStateManagement() {
        function updateFieldFilledState() {
            if ($(this).is('input[type="number"]') && $(this).val() > 0 || !$(this).is('input[type="number"]') && $(this).val()) {
                $(this).addClass('filled');
            } else {
                $(this).removeClass('filled');
            }
        }

        function updateFormDependencies() {
            const firstVisit = $('#first-visit').val();
            const hearAboutUs = $('#hear-about-us');
            const otherHearAboutUs = $('#other-hear-about-us');

            // First Visit -> How did you hear about us
            hearAboutUs.prop('disabled', firstVisit !== 'yes');
            
            // How did you hear about us -> Other specification
            if (hearAboutUs.val() === 'other') {
                otherHearAboutUs.show().prop('disabled', false);
            } else {
                otherHearAboutUs.hide().prop('disabled', true);
            }
        }

        // Attach event listeners
        $('input, textarea, select').on('input change', updateFieldFilledState);
        $('#first-visit, #hear-about-us').on('change', updateFormDependencies);
        
        // Handle form reset
        $('form').on('reset', function() {
            setTimeout(function() {
                $('input, textarea, select').each(updateFieldFilledState);
                updateFormDependencies();
                updateFormSummaryAndVisibility();
                $('#otherOptions').collapse('hide');
            }, 0);
        });

        // Initialize on page load
        $('input, textarea, select').each(updateFieldFilledState);
        updateFormDependencies();
    }

    function initializeFormValidation() {
        $('form').submit(function(event) {
            let totalVisitors = 0;
            let dogCount = parseInt($('#dogs').val()) || 0;
            
            $('.visitor-count').each(function() {
                if ($(this).attr('id') !== 'dogs') {
                    totalVisitors += parseInt($(this).val()) || 0;
                }
            });

            if (totalVisitors === 0) {
                if (dogCount > 0) {
                    alert('Dogs must be accompanied by at least one visitor');
                } else {
                    alert('Please enter at least one visitor');
                }
                event.preventDefault();
                event.stopImmediatePropagation();
            }
        });
    }

    function initializeResetConfirmation() {
        $('button[type="reset"]').click(function(event) {
            if (!confirm('Are you sure you want to reset the form?')) {
                event.preventDefault();
            }
        });
    }

    function initializeFormSubmission() {
        $('form').submit(function(event) {
            event.preventDefault();

            const submitButton = $(this).find('button[type="submit"]');
            submitButton.prop('disabled', true).text('Processing...');

            const formData = new FormData(this);
            formData.append('timestamp', new Date().toISOString());
            formData.append('price', calculateTotalPrice().toFixed(2));

            const body = { 
                record: Object.fromEntries(formData.entries()), 
                authToken: localStorage.getItem('authToken')
            };

            fetch(appsScriptUrl, {
                method: 'POST',
                headers: {
                    "Content-Type": "text/plain;charset=utf-8",
                },
                body: JSON.stringify(body)
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error('An error occurred while submitting the form');
                }

                const res = await response.text();
                switch (res) {
                    case 'Success':
                        showAlert('✓ Visit Recorded', 5000);
                        $('form').trigger('reset');
                        break;
                    case 'Unauthorized':
                        alert('Unauthorized access. The secret token is incorrect. Please enter correct token and then try again.');
                        promptForToken(true);
                        break;
                    default:
                        throw new Error('Unexpected response from server: ' + res);
                }
            })
            .catch(error => {
                alert(error);
            })
            .finally(() => {
                submitButton.prop('disabled', false).text('Submit');
            });
        });
    }

    function initializePostcodeModal() {
        const modal = $('.postcode-modal');
        const backdrop = $('.postcode-modal-backdrop');
        const input = $('#postcode');
        const modalInput = $('#postcodeInput');

        function saveAndHide() {
            const value = modalInput.val().trim();
            input.val(value).trigger('change');
            backdrop.fadeOut();
            modal.removeClass('show');
        }

        function showModal() {
            backdrop.fadeIn();
            modal.addClass('show');
            modalInput.val(input.val()).focus();
        }

        input.on('click', showModal);
        $('#donePostcode').on('click', saveAndHide);
        
        modalInput
            .on('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveAndHide();
                }
            })
            .on('blur', function() {
                saveAndHide();
            });
    }

    // Single document.ready that calls all initialization functions
    $(document).ready(function() {
        promptForToken();
        initializeZoomControls();
        initializeVisitorInputs();
        initializeNumberControls();
        initializeAccordionBehavior();
        initializeFormStateManagement();
        initializeFormValidation();
        initializeResetConfirmation();
        initializeFormSubmission();
        initializePostcodeModal();
        updateFormSummaryAndVisibility();
    });
})();
</script>