<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admissions Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="locationPicker.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0 1em;
            height: 100vh;
        }
        .zoom-controls {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
            margin: 1em;
        }
        .filled {
            background-color: lightgreen;
        }
        .no input[type="number"] {
            text-align: center;
        }
        input[type='number']::-webkit-inner-spin-button, 
        input[type='number']::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        .grid-container {
            display: grid;
            gap: 1.5rem;
            margin: 1.5em 0;
        }
        .grid-container.visitor-counts {
            grid-template-columns: repeat(auto-fit, minmax(133px, 175px));
            grid-auto-rows: minmax(70px, auto);
            justify-content: space-evenly;
        }
        .grid-container.other {
            grid-template-columns: repeat(auto-fit, minmax(133px, 1fr));
            grid-auto-rows: minmax(70px, auto);
        }
        .no {
            text-align: center;
        }
        label:has(~ select[disabled]) {
            color: lightgray;
        }
        .form-footer {
            text-align: center;
            padding-bottom: 6em;
        }
        .with-gift-aid label:after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: text-bottom;
            background: url('images/gift-icon.svg') no-repeat center;
            background-size: contain;
            margin-left: 4px;
        }
        .alert-float {
            position: fixed;
            top: 1em;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
            display: none;
            padding: 1em 2em;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .accordion-button::after {
            margin-left: 0;
            margin-right: 0.5em;
            order: -1;
        }
        .accordion-button {
            display: flex;
            justify-content: flex-start;
        }
        .no .btn {
            font-family: monospace;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            z-index: 9999;
        }
        .loading-status {
            color: #6c757d;
            font-size: 1.1rem;
            text-align: center;
        }
        form {
            display: none;
            font-size: 1.25rem;
        }
        .confirmation-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }
        .confirmation-table td {
            padding: 0.5rem 0;
            border: none;
        }
        .confirmation-table td:first-child {
            text-align: left;
        }
        .confirmation-table td:last-child {
            text-align: right;
        }
        .confirmation-table tr.total td {
            padding-top: 1rem;
            border-top: 2px solid #dee2e6;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .gift-aid-section {
            display: none;
            margin-top: 2rem;
        }
        .gift-aid-callout {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid #dde8f0;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
        }
        .gift-aid-callout.warning {
            border-color: #e63946;
            box-shadow: 0 0 0 4px rgba(230, 57, 70, 0.18);
            transform: translateY(-2px);
        }
        .gift-aid-callout .form-check {
            margin-bottom: 0;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        .gift-aid-callout .form-check-input {
            margin-top: 0.15rem;
        }
        #giftAidConfirm {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #5a8ed4;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #giftAidConfirm:focus-visible {
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(90, 142, 212, 0.35);
        }
        .gift-aid-label {
            font-weight: 600;
            font-size: 1.05rem;
            color: #0f172a;
            margin: 0;
        }
        .gift-aid-note {
            font-size: 0.95rem;
            color: #4f5663;
            line-height: 1.4;
            margin: 0;
        }
        .gift-aid-warning-text {
            font-size: 0.9rem;
            color: #ba1a1a;
            margin: 0;
            display: none;
        }
        .gift-aid-callout.warning .gift-aid-warning-text {
            display: block;
        }
        .today-totals {
            display: none;
            justify-content: center;
            margin-top: 1rem;
            width: 100%;
        }
        .today-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.85rem;
            border-radius: 999px;
            background: #f1f5f9;
            color: #0f172a;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            letter-spacing: 0.005em;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div id="loadingStatus" class="loading-status">Initializing...</div>
    </div>
    <div class="today-totals" id="todayTotalsContainer" aria-live="polite">
        <div class="today-pill" id="todayTotalsPill">Loading today totals...</div>
    </div>
    <!-- Template for visitor count inputs -->
    <template id="visitor-count-template">
        <div class="no">
            <label for="" class="form-label"></label>
            <div class="input-group input-group-lg">
                <input type="number" readonly id="" name="" min="0" value="0" step="1" class="form-control form-control-lg fs-3 visitor-count">
            </div>
        </div>
    </template>

    <form action="/submit" method="post" autocomplete="off">
        <div id="visitorCounts" class="grid-container visitor-counts">
        </div>
        <div class="grid-container other">
            <div style="grid-column: 1;">
                <label for="postcode" class="form-label">Postcode/Country</label>
                <input type="text" id="postcode" name="postcode" required style="text-transform: uppercase;" class="form-control form-control-lg" readonly inputmode="none" aria-haspopup="dialog">
            </div>
            <div>
                <label for="reason-for-visit" class="form-label">Reason for Visit</label>
                <select id="reason-for-visit" name="reason-for-visit" class="form-control form-control-lg" required>
                </select>
            </div>
            <div>
                <label for="first-visit" class="form-label">First Visit?</label>
                <select id="first-visit" name="first-visit" class="form-control form-control-lg" required>
                    <option value="" disabled selected>&nbsp;</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div style="grid-column: span 2;">
                <label for="hear-about-us" class="form-label">How did you hear about us?</label>
                <select id="hear-about-us" name="hear-about-us" class="form-control form-control-lg" required>
                </select>
                <input type="text" id="other-hear-about-us" name="other-hear-about-us" class="form-control form-control-lg" style="display: none;" placeholder="Please specify" disabled required>
            </div>
        </div>
        <div class="form-footer">
            <p id="members-only-message" style="display: none;">(No other fields required as only members visiting)</p>
            <p id="summary-message" class="text-muted mb-3"></p>
            <button type="submit" class="btn btn-lg btn-primary">Submit</button>
            <button type="reset" class="btn btn-lg btn-secondary">Reset</button>
        </div>
    </form>
    <div class="modal" id="postcodeModal" tabindex="-1" aria-labelledby="postcodeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="postcodeModalLabel">Enter Postcode/Country</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="postcodeInput" class="form-control form-control-lg mb-3" style="text-transform: uppercase;" autofocus>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-lg" id="donePostcode">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmationModal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm tickets and total price matches till before submitting</h5>
                </div>
                <div class="modal-body">
                    <table class="confirmation-table">
                        <tbody id="confirmationTableBody">
                        </tbody>
                    </table>
                    <div id="giftAidSection" class="gift-aid-section">
                        <div class="gift-aid-callout">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="giftAidConfirm" name="gift-aid-form-completed" required>
                                <label class="form-check-label gift-aid-label" for="giftAidConfirm">
                                    Visitors have completed the Gift Aid form
                                </label>
                            </div>
                            <p class="gift-aid-note">
                                Gift Aid form must be completed by visitors, including the total amount.
                            </p>
                            <p class="gift-aid-warning-text" aria-live="assertive">
                                Please tick this box once the Gift Aid form is completed.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back to Edit</button>
                    <button type="button" class="btn btn-primary" id="confirmSubmit">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-body d-flex flex-column align-items-center gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="fs-3 text-success" aria-hidden="true">✓</span>
                        <p class="fs-5 mb-0" id="successModalLabel">Visit Recorded</p>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script>
(() => {
    // Polyfill for android 7.0 support
    if (!Object.fromEntries) {
        Object.fromEntries = function(iterable) {
            return [...iterable].reduce((obj, [key, val]) => {
            obj[key] = val;
            return obj;
            }, {});
        };
    }

    const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbxHcA7M1eB1RZ8WIXiEZGv57kT8No0-Np9HsjHBrCIJMgUc0yVRDeg2dIXXFutWXASRxw/exec';

    let visitorTypes = []; // This will be populated dynamically

    // State to manage form data
    const formState = {
        defaultReasonForVisit: '',
        heardAboutUsOther: 'Other - please specify', // Must match spreadsheet ID
        childTypeId: 'child' // Must match spreadsheet ID
    };
    const todayTotalsDefaults = { totalVisitors: 0, totalPrice: 0, totalDonation: 0 };
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    const queryParams = new URLSearchParams(window.location.search);
    const useLegacyPostcodeModal = (() => {
        const postcodeModal = (queryParams.get('postcodeModal') || '').trim().toLowerCase();
        return postcodeModal !== 'new';
    })();

    /**
     * Fetch wrapper with configurable retries/backoff.
     * Can replace most fetch calls: fetchWithRetry(url, options, retryOptions)
     */
    function fetchWithRetry(url, options = {}, retryOptions = {}) {
        const {
            retries = 3,
            retryDelay = 500,
            backoffFactor = 2,
            retryOn = (response, error) => {
                if (error) return true; // network/connection errors
                if (!response) return false;
                const { status } = response;
                return status === 429 || status >= 500;
            }
        } = retryOptions;

        let attempt = 0;
        let delay = retryDelay;

        const attemptRequest = () => {
            return fetch(url, options)
                .then(response => {
                    if (!retryOn(response, null, attempt) || attempt >= retries) {
                        return response;
                    }
                    const currentDelay = delay;
                    attempt++;
                    delay *= backoffFactor;
                    return wait(currentDelay).then(attemptRequest);
                })
                .catch(error => {
                    if (!retryOn(null, error, attempt) || attempt >= retries) {
                        throw error;
                    }
                    const currentDelay = delay;
                    attempt++;
                    delay *= backoffFactor;
                    return wait(currentDelay).then(attemptRequest);
                });
        };

        return attemptRequest();
    }

    function renderTodayTotals(totals, options = {}) {
        const pill = $('#todayTotalsPill');
        if (options.loading) {
            pill.text('Loading today totals...');
        } else if (!totals || options.error) {
            pill.text('Today totals unavailable');
        } else {
            const visitorLabel = totals.totalVisitors === 1 ? 'visitor' : 'visitors';
            const donationPart = totals.totalDonation > 0 ? ` · donations £${Number(totals.totalDonation).toFixed(2)}` : '';
            pill.text(`Today: ${totals.totalVisitors} ${visitorLabel} · £${Number(totals.totalPrice).toFixed(2)}${donationPart}`);
        }
        $('#todayTotalsContainer').css('display', 'flex');
    }

    function fetchTodayTotals(options = {}) {
        const token = localStorage.getItem('authToken');
        if (!token) {
            renderTodayTotals(todayTotalsDefaults, { error: true });
            return Promise.resolve();
        }

        if (!options.quiet) {
            renderTodayTotals(todayTotalsDefaults, { loading: true });
        }

        return fetchWithRetry(`${appsScriptUrl}?action=getTodayTotals&authToken=${token}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Request failed (${response.status})`);
                }
                return response.text();
            })
            .then(text => {
                if (text === 'Unauthorized') {
                    throw new Error('Unauthorized');
                }
                const data = JSON.parse(text);
                renderTodayTotals(data || todayTotalsDefaults);
            })
            .catch(error => {
                console.error('Failed to fetch today totals:', error);
                renderTodayTotals(todayTotalsDefaults, { error: true });
                if (!options.quiet) {
                    showAlert('Unable to load today totals right now');
                }
            });
    }

    function calculateTotalPrice() {
        let totalPrice = 0;
        let totalChildren = 0;
        let totalAdults = 0;

        visitorTypes.forEach(type => {
            const count = parseInt($(`#${type.id}`).val()) || 0;
            totalPrice += count * type.price;

            if (type.isAdult) {
                totalAdults += count;
            } else if (type.id === formState.childTypeId) {
                totalChildren += count;
            }
        });

        // Apply special pricing for children-only visits
        if (totalChildren > 0 && totalAdults === 0) {
            totalPrice += totalChildren * 1;
        }

        return totalPrice;
    }

    function updateFormSummaryAndVisibility() {
        let totalAdults = 0;
        let totalChildren = 0;
        let totalVisitors = 0;
        const totalMembers = parseInt($('#members').val()) || 0;

        visitorTypes.forEach(type => {
            const count = parseInt($(`#${type.id}`).val()) || 0;
            if (type.isAdult) {
                totalAdults += count;
            } else if (type.id === formState.childTypeId) {
                totalChildren += count;
            }
            totalVisitors += count;
        });

        // Update summary message
        let summaryParts = [];
        if (totalAdults > 0) {
            summaryParts.push(`${totalAdults} adult${totalAdults !== 1 ? 's' : ''}`);
        }
        if (totalChildren > 0) {
            summaryParts.push(`${totalChildren} ${totalChildren === 1 ? 'child' : 'children'}`);
        }
        
        let summaryText = summaryParts.join(', ');
        if (summaryText) {
            summaryText += ` - £${calculateTotalPrice().toFixed(2)}`;
        }
        $('#summary-message').text(summaryText || 'No visitors selected');

        // Toggle visibility and required state of additional fields
        const isMembersOnly = totalAdults > 0 && totalMembers === totalAdults;
        $('.grid-container.other').toggle(!isMembersOnly);
        $('#members-only-message').toggle(isMembersOnly);
        
        // Update required attributes
        $('#postcode, #first-visit, #hear-about-us').prop('required', !isMembersOnly);
    }

    async function verifyToken(token) {
        if (!token) {
            return { valid: false, unauthorized: false, error: 'No token provided' };
        }
        try {
            const response = await fetchWithRetry(`${appsScriptUrl}?action=checkCredentials&authToken=${token}`, {
                method: 'GET',
                headers: {
                    "Content-Type": "text/plain;charset=utf-8"
                }
            });
            const text = await response.text();
            if (text === 'Unauthorized') {
                return { valid: false, unauthorized: true };
            }
            return { valid: true, unauthorized: false };
        } catch (error) {
            console.error('Error verifying token:', error);
            return { valid: false, unauthorized: false, error: error?.message || 'Network error' };
        }
    }

    function getAuthTokenFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('k');
        if (token) {
            // Remove token from URL without reloading
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        return token;
    }

    function authenticate(clearExisting = false, updateStatus = () => {}) {
        if (clearExisting) {
            localStorage.removeItem('authToken');
        }

        const MAX_RETRIES = 3;

        async function verifyWithRetry(token, contextMessage) {
            let attempt = 0;
            let lastError = '';
            while (attempt < MAX_RETRIES) {
                const verification = await verifyToken(token);
                if (verification.valid || verification.unauthorized) {
                    return verification;
                }
                lastError = verification.error || 'Unknown error';
                attempt++;
                updateStatus(`${contextMessage} (${lastError}) - retrying (${attempt}/${MAX_RETRIES})...`);
                if (attempt < MAX_RETRIES) {
                    await wait(2000);
                }
            }
            const message = `${contextMessage} failed after ${MAX_RETRIES} attempts${lastError ? `: ${lastError}` : ''}`;
            updateStatus(message);
            return { valid: false, unauthorized: false, error: message };
        }

        return new Promise(async (resolve, reject) => {
            async function checkAndSetToken(token, contextMessage) {
                const verification = await verifyWithRetry(token, contextMessage);
                if (verification.valid) {
                    localStorage.setItem('authToken', token);
                    return verification;
                }
                if (verification.unauthorized) {
                    localStorage.removeItem('authToken'); // Clear only unauthorized token
                    return verification;
                }
                throw new Error(verification.error || 'Unable to verify token');
            }

            let msg = 'Please enter the secret token:';

            const urlToken = getAuthTokenFromUrl();
            if (urlToken) {
                try {
                    const result = await checkAndSetToken(urlToken, 'Verifying token from the URL');
                    if (result.valid) {
                        resolve();
                        return;
                    }
                    if (result.unauthorized) {
                        msg = 'The token from the URL is incorrect. Please enter the secret token:';
                    }
                } catch (error) {
                    reject(error);
                    return;
                }
            }

            const existingToken = localStorage.getItem('authToken');
            if (existingToken) {
                try {
                    const result = await checkAndSetToken(existingToken, 'Verifying existing token');
                    if (result.valid) {
                        resolve();
                        return;
                    }
                    if (result.unauthorized) {
                        msg = 'The existing token is incorrect. Please enter the secret token:';
                    }
                } catch (error) {
                    reject(error);
                    return;
                }
            }
            
            while (true) {
                const token = prompt(msg);
                try {
                    const result = await checkAndSetToken(token, 'Verifying provided token');
                    if (result.valid) {
                        resolve();
                        return;
                    }
                    if (result.unauthorized) {
                        msg = 'The token is incorrect. Please try again.';
                    }
                } catch (error) {
                    reject(error);
                    return;
                }
            }
        });
    }

    function showAlert(message, duration = 3000) {
        const alert = $('#alertMessage');
        alert.text(message).fadeIn();
        setTimeout(() => alert.fadeOut(), duration);
    }

    function initializeZoomControls() {
        const zoomButtons = $('<div class="btn-group zoom-controls" role="group" aria-label="Zoom buttons"></div>');
        const zoomLevels = [1, 1.25, 1.5, 1.75];
        const zoomTarget = $('body');

        const applyZoom = (level) => {
            zoomTarget.css('zoom', level);
        };

        // Ensure base zoom is 1 so 1x = default size
        applyZoom(1);

        zoomLevels.forEach(level => {
            const zoomButton = $(`<button type="button" class="btn btn-secondary ${level === 1 ? 'active' : ''}">${level}x</button>`);
            zoomButton.click(function() {
                applyZoom(level);
                zoomButtons.find('button').removeClass('active');
                $(this).addClass('active');
            });
            zoomButtons.append(zoomButton);
        });

        $('body').prepend(zoomButtons);
    }

    function initializeVisitorInputs() {
        visitorTypes.forEach(type => {
            const template = $('#visitor-count-template').html();
            const newElement = $(template).clone();

            newElement.find('label')
                .attr('for', type.id)
                .text(type.shortLabel)
                .attr('title', type.label)
                .attr('data-bs-toggle', 'tooltip')
                .attr('data-bs-placement', 'top');
            
            const input = newElement.find('input')
                .attr('id', type.id)
                .attr('name', type.id);

            if (type.donation > 0) {
                newElement.addClass('with-gift-aid');
            }

            $('#visitorCounts').append(newElement);
        });

        $('[data-bs-toggle="tooltip"]').tooltip();
        $('.visitor-count').on('input change', updateFormSummaryAndVisibility);
    }

    function initializeNumberControls() {
        const numberInputs = $('.no input[type="number"]');

        numberInputs.each(function() {
            const numberInput = $(this);
            const minusButton = $('<button type="button" class="btn btn-outline-secondary btn-lg fs-3">-</button>');
            const plusButton = $('<button type="button" class="btn btn-outline-secondary btn-lg fs-3">+</button>');

            numberInput.before(minusButton);
            numberInput.after(plusButton);

            minusButton.click(function() {
                numberInput[0].stepDown();
                numberInput.trigger('input');
            });

            plusButton.click(function() {
                numberInput[0].stepUp();
                numberInput.trigger('input');
            });
        });
    }
    
    function initializeFormStateManagement() {
        function updateFieldFilledState() {
            if ($(this).is('input[type="checkbox"]')) {
                return; // Skip checkboxes
            }
            if ($(this).is('input[type="number"]') && $(this).val() > 0 || !$(this).is('input[type="number"]') && $(this).val()) {
                $(this).addClass('filled');
            } else {
                $(this).removeClass('filled');
            }
        }

        function updateFormDependencies() {
            const hearAboutUs = $('#hear-about-us');
            const otherHearAboutUs = $('#other-hear-about-us');

            // How did you hear about us -> Other specification
            if (hearAboutUs.val() === formState.heardAboutUsOther) {
                otherHearAboutUs.show().prop('disabled', false);
            } else {
                otherHearAboutUs.hide().prop('disabled', true);
                otherHearAboutUs.val(''); // Clear the other field when not visible
            }
        }

        // Attach event listeners
        $('input, textarea, select').on('input change', updateFieldFilledState);
        $('#hear-about-us').on('change', updateFormDependencies);
        
        // Handle form reset
        $('form').on('reset', function() {
            setTimeout(function() {
                $('input, textarea, select').each(updateFieldFilledState);
                updateFormDependencies();
                updateFormSummaryAndVisibility();
                
                // Restore defaults
                if (formState.defaultReasonForVisit) {
                    $('#reason-for-visit').val(formState.defaultReasonForVisit);
                }
            }, 0);
        });

        // Initialize on page load
        $('input, textarea, select').each(updateFieldFilledState);
        updateFormDependencies();
    }

    function initializeFormValidation() {
        $('form').submit(function(event) {
            let totalVisitors = 0;
            
            $('.visitor-count').each(function() {
                totalVisitors += parseInt($(this).val()) || 0;
            });

            if (totalVisitors === 0) {
                alert('Please enter at least one visitor');
                event.preventDefault();
                event.stopImmediatePropagation();
            }
        });
    }

    function initializeResetConfirmation() {
        $('button[type="reset"]').click(function(event) {
            if (!confirm('Are you sure you want to reset the form?')) {
                event.preventDefault();
            }
        });
    }

    function calculateTotalDonations() {
        let totalDonations = 0;
        visitorTypes.forEach(type => {
            const count = parseInt($(`#${type.id}`).val()) || 0;
            totalDonations += count * type.donation;
        });
        return totalDonations;
    }

    function initializeFormSubmission() {
        const confirmationModal = new bootstrap.Modal($('#confirmationModal')[0]);
        const successModal = new bootstrap.Modal($('#successModal')[0]);
        const form = $('form');

        form.submit(function(event) {
            event.preventDefault();

            const ticketDetails = visitorTypes.map(type => {
                const count = parseInt($(`#${type.id}`).val()) || 0;
                return { label: type.label, count, price: type.price, subtotal: count * type.price };
            }).filter(detail => detail.count > 0);

            const total = ticketDetails.reduce((sum, detail) => sum + detail.subtotal, 0);

            // Build confirmation table
            const tableBody = $('#confirmationTableBody');
            tableBody.empty();
            
            ticketDetails.forEach(detail => {
                const row = $('<tr></tr>');
                row.append(`<td>${detail.label}</td>`);
                row.append(`<td style="text-align: right; padding-right: 1rem;">${detail.count} × £${detail.price.toFixed(2)}</td>`);
                row.append(`<td style="text-align: right;">£${detail.subtotal.toFixed(2)}</td>`);
                tableBody.append(row);
            });

            // Add total row
            const totalRow = $('<tr class="total"></tr>');
            totalRow.append('<td colspan="2">Total</td>');
            totalRow.append(`<td style="text-align: right;">£${total.toFixed(2)}</td>`);
            tableBody.append(totalRow);
        
            // Show/hide gift aid section based on whether there are any donations
            const hasGiftAid = calculateTotalDonations() > 0;
            $('#giftAidSection').toggle(hasGiftAid);
            if (!hasGiftAid) {
                clearGiftAidWarning();
            }
            
            // Show modal using Bootstrap API
            confirmationModal.show();
        });

        const giftAidCallout = $('.gift-aid-callout');
        const giftAidCheckbox = $('#giftAidConfirm');

        function showGiftAidWarning() {
            giftAidCallout.addClass('warning');
            giftAidCheckbox.focus();
        }

        function clearGiftAidWarning() {
            giftAidCallout.removeClass('warning');
        }

        giftAidCheckbox.change(clearGiftAidWarning);

        $('#confirmSubmit').click(function() {
            // If Gift Aid section is shown, require the confirmation checkbox
            if ($('#giftAidSection').is(':visible') && !$('#giftAidConfirm').is(':checked')) {
                showGiftAidWarning();
                return;
            }

            clearGiftAidWarning();
            confirmationModal.hide();

            const submitButton = form.find('button[type="submit"]');
            submitButton.prop('disabled', true).text('Processing...');

            const formData = new FormData(form[0]);
            formData.append('timestamp', new Date().toISOString());
            formData.append('price', calculateTotalPrice().toFixed(2));
            formData.append('donation', calculateTotalDonations().toFixed(2)); // Add donations

            const body = { 
                record: Object.fromEntries(formData.entries()), 
                authToken: localStorage.getItem('authToken')
            };

            fetch(appsScriptUrl, {
                method: 'POST',
                headers: {
                    "Content-Type": "text/plain;charset=utf-8",
                },
                body: JSON.stringify(body)
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error('An error occurred while submitting the form');
                }

                const res = await response.text();
                switch (res) {
                    case 'Success':
                        fetchTodayTotals({ quiet: true });
                        successModal.show();
                        $('form').trigger('reset');
                        $('#giftAidConfirm').prop('checked', false);
                        break;
                    case 'Unauthorized':
                        alert('Unauthorized access. The secret token is incorrect. Please enter correct token and then try again.');
                        authenticate(true);
                        break;
                    default:
                        throw new Error('Unexpected response from server: ' + res);
                }
            })
            .catch(error => {
                alert(error);
            })
            .finally(() => {
                submitButton.prop('disabled', false).text('Submit');
            });
        });
    }

    function initializeLegacyPostcodeModal() {
        const modalElement = $('#postcodeModal');
        const modal = new bootstrap.Modal(modalElement[0]);
        const input = $('#postcode');
        const modalInput = $('#postcodeInput');

        input.removeAttr('readonly');
        input.removeAttr('inputmode');
        input.removeAttr('aria-haspopup');

        function saveAndHide() {
            const value = modalInput.val().trim();
            input.val(value).trigger('change');
            modal.hide();
        }

        function showModal() {
            modalInput.val(input.val());
            modal.show();
        }

        modalElement.on('shown.bs.modal', function () {
            modalInput.trigger('focus');
            modalInput.select();
        });

        input.on('focus', showModal);
        input.on('click', showModal);
        $('#donePostcode').on('click', saveAndHide);
        
        modalInput
            .on('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveAndHide();
                }
            })
            .on('blur', function() {
                saveAndHide();
            });
    }

    function initializeLocationPickerInput() {
        const input = document.getElementById('postcode');
        if (!input || !window.LocationPicker) {
            console.warn('LocationPicker unavailable; using plain postcode input');
            if (input) {
                input.removeAttribute('readonly');
                input.removeAttribute('inputmode');
                input.removeAttribute('aria-haspopup');
            }
            return () => {};
        }

        return window.LocationPicker.attachToInput(input, {
            onConfirm: () => $('#postcode').trigger('change')
        });
    }

    function initializePostcodeInput() {
        if (useLegacyPostcodeModal) {
            initializeLegacyPostcodeModal();
            return;
        }
        initializeLocationPickerInput();
    }

    function initializeVisitorTypes() {
        return fetchWithRetry(`${appsScriptUrl}?action=getVisitorTypes&authToken=${localStorage.getItem('authToken')}`)
            .then(response => response.text())
            .then(text => {
                const data = JSON.parse(text);
                visitorTypes = data.map(row => {
                    
                    return {
                        id: row[0],
                        label: row[1],
                        shortLabel: row[2],
                        price: row[3] ? parseFloat(row[3]) : 0,
                        isAdult: row[4].toLowerCase() === 'yes',
                        visibleByDefault: row[5].toLowerCase() === 'yes', // Column is "Frequently used" in the sheet
                        donation: row[6] ? parseFloat(row[6]) : 0
                    };
                });
            });
    }

    function initializeReasonForVisit() {
        return fetchWithRetry(`${appsScriptUrl}?action=getReasonsForVisit&authToken=${localStorage.getItem('authToken')}`)
            .then(response => response.text())
            .then(text => {
                const data = JSON.parse(text);
                const select = $('#reason-for-visit');
                select.empty();
                select.append('<option value="" disabled selected></option>');
                
                data.forEach(row => {
                    const option = $('<option>', {
                        value: row[0],
                        text: row[0]
                    });
                    
                    // If second column is 'Y', set as default selected
                    if (row[1] === 'Yes') {
                        option.prop('selected', true);
                        formState.defaultReasonForVisit = row[0];
                    }
                    
                    select.append(option);
                });
            });
    }

    function initializeHowHeardAboutUs() {
        return fetchWithRetry(`${appsScriptUrl}?action=getHeardAboutUs&authToken=${localStorage.getItem('authToken')}`)
            .then(response => response.text())
            .then(text => {
                const data = JSON.parse(text);
                const select = $('#hear-about-us');
                select.empty();
                select.append('<option value="" disabled selected></option>');
                
                data.forEach(row => {
                    const option = $('<option>', {
                        value: row[0],
                        text: row[0]
                    });
                    select.append(option);
                });
            });
    }

    // Single document.ready that calls all initialization functions
    $(document).ready(function() {

        function updateLoadingStatus(message) {
            $('#loadingStatus').text(message);
        }
        // Initialize everything in sequence
        updateLoadingStatus('Authenticating...');
        authenticate(false, updateLoadingStatus)
            .then(() => {
                updateLoadingStatus('Loading form options...');
                return Promise.all([
                    initializeVisitorTypes(),
                    initializeReasonForVisit(),
                    initializeHowHeardAboutUs()
                ]);
            })
            .then(() => {
                initializeZoomControls();
                initializeVisitorInputs();
                initializeNumberControls();
                initializeFormValidation();
                initializeResetConfirmation();
                initializeFormSubmission();
                initializePostcodeInput();
                initializeFormStateManagement();
                updateFormSummaryAndVisibility();
                fetchTodayTotals();
                
                // Show form and hide loading overlay
                $('#loadingOverlay').fadeOut();
                $('form').fadeIn();
            })
            .catch(error => {
                $('.spinner-border').hide();
                updateLoadingStatus('Error initializing form: ' + (error.message || 'An error occurred'));
                console.error('Error initializing form:', error);
            });
    });
})();
</script>
